{% extends 'project_management/index.html' %}
{% load static %}
{% load extra_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'custom/to_do/to_do.css' %}">
{% endblock extra_css %}

{% block content %}
      <div class="container-fluid">
         <div class="row">
            <div class="col-sm-12 col-lg-6 col-md-6">
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                     <div class="header-title">
                        <h4 class="card-title">Project Preview</h4>
                     </div>
                  </div>
                  <div class="card-body">
                      <div class="row">
                           <div class="col-12">
                              <p style="margin-bottom:0;">Title:</p>
                              <h5>{{ object.project_name.upper }}</h5>
                          </div>
                          <div class="mt-5 col-12">
                              <p style="margin-bottom:0px;">Project Description:</p>
                              <p class="text-justify">{{ object.project_description }}</p>
                          </div>
                          <div class="mt-3 col-12">
                              <p style="margin-bottom:0px;">Project Category:</p>
                              <p>{{ object.department_category }}</p>
                          </div>
                          <div class="mt-3 col-6">
                              <p style="margin-bottom:0px;">Start Date:</p>
                              <p>{{ object.start_date }}</p>
                          </div>
                          <div class="mt-3 col-6">
                              <p style="margin-bottom:0px;">Due Date:</p>
                              <p>{{ object.due_date }}</p>
                          </div>
                      </div>
                  </div>
               </div>
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                     <div class="header-title">
                        <h4 class="card-title">Targets</h4>
                     </div>
                  </div>
                  <div class="card-body">
                      <ul class="list-group list-group-flush">
                          {% for target in object.target.all %}
                              <li id="pk{{ target.pk }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                  <span class="d-flex justify-content-between">
                                      <div class="custom-control-inline">
                                          <input class="triStateCheckbox" data-state="{{ target.state }}" type="checkbox" onclick="toggle_target(this, '{{ target.pk }}')" style="transform: scale(2)">
                                      </div>
                                      {{ target.target_name }}

                                      {% if target.state == 'Completed' %}
                                          <h6> - <small>on {{ target.date|date:"jS E, Y" }}</small> </h6>
                                      {% endif %}
                                  </span>

                                  {% if target.state == 'Completed' %}
                                      <span class="badge badge-success badge-pill status">Completed</span>
                                  {% elif target.state == 'Pending' %}
                                      <span class="badge badge-warning badge-pill status">Pending</span>
                                  {% else %}
                                      <span class="badge badge-danger badge-pill status">Not Started</span>
                                  {% endif %}
                              </li>
                          {% empty %}
                              <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">No Target</li>
                          {% endfor %}
                      </ul>

                  </div>
               </div>
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                     <div class="header-title">
                        <h4 class="card-title">Assigned Members</h4>
                     </div>
                  </div>
                  <div class="card-body">
                     <ul class="list-unstyled col-12 p-0 m-0 row">
                          {% for member in object.project_members.all %}
                              <li class="col-6 mt-2">
                                  <img src="{{ member.member_name.profile_pic.url }}" class="img-thumbnail w-100 img-fluid rounded" alt="Assigned Members" title="{{ member.member_name.get_full_name }}">
                                  <span>{{ member.member_name.get_full_name }}</span>
                              </li>
                          {% endfor %}
                     </ul>
                  </div>
               </div>
            </div>
            <div class="col-sm-12 col-lg-6 col-md-6">
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                     <div class="header-title">
                        <h4 class="card-title">Edit Project</h4>
                     </div>
                  </div>
                  <div class="card-body">
                      <div class="row">
                          {% csrf_token %}

                          <div class="form-group mb-3 col-12">
                              <label for="project_name" class="pb-0">Project Title</label>
                              <input type="text" class="form-control form-control-lg" id="project_name" value="{{ object.project_name }}" placeholder="Project Description" />
                          </div>

                          <div class="form-group mb-3 col-12">
                              <label for="project_description">Project Description</label>
                              <textarea class="form-control" id="project_description" placeholder="Project Description" rows="3">{{ object.project_description }}</textarea>
                          </div>

                          <div class="form-group mb-3 col-12">
                              <label for="project_category">Category</label>
                              <select id="project_category" class="form-control form-control-lg">
                                  {% for category in department_categories %}
                                      <option value="{{ category.category_name }}" {% if category.category_name == object.department_category.category_name %}selected{% endif %} >
                                          {{ category.category_name }}
                                      </option>
                                  {% empty %}
                                      <option disabled>No Category</option>
                                  {% endfor %}
                              </select>
                          </div>

                          <div class="form-group mb-3 col-6">
                              <label for="project_start_date" class="pb-0">Start Date</label>
                              <input type="date" id="project_start_date" class="form-control form-control-lg" value="{{ object.start_date.isoformat }}" />
                          </div>

                          <div class="form-group mb-3 col-6">
                              <label for="project_due_date" class="pb-0">Due Date</label>
                              <input type="date" id="project_due_date" class="form-control form-control-lg" value="{{ object.due_date.isoformat }}" />
                          </div>
                      </div>
                  </div>
               </div>
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                      <div class="header-title">
                          <h4 class="card-title">Edit Team</h4>
                      </div>
                  </div>
                  <div class="card-body">

                      <div class="form-group mb-3 col-12">
                          <label for="project_members">Team Members</label>
                          <select id="project_members" class="selectpicker form-control form-control-lg" data-style="py-0" multiple required>
                              {% for member in department_members %}
                                  <option value="{{ member.id }}" {% if member in object.project_members.all %}selected{% endif %}>
                                      {{ member.member_name.get_full_name }}
                                  </option>
                              {% empty %}
                                  <option disabled>No Category</option>
                              {% endfor %}
                          </select>
                      </div>
                  </div>
               </div>
               <div class="card">
                  <div class="card-header d-flex justify-content-between">
                     <div class="header-title">
                        <h4 class="card-title">Edit Target</h4>
                     </div>
                  </div>
                  <div class="card-body">
                      {% include 'custom_html/to_do.html' %}
                  </div>
               </div>
               <div class="card">
                  <div class="card-body">
                      <div class="col-12">
                          <button id="submit_button" type="button" class="btn btn-primary btn-lg" onclick="save_project()">SAVE PROJECT</button>
                      </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

{% endblock content %}

{% block modal %}
{% endblock modal %}

{% block extra_js %}
    <script src="{% static 'custom/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static 'custom/to_do/to_do.js' %}"></script>
    <script src="{% static 'custom/custom.js' %}"></script>
    <script>
        const check_boxes = document.querySelectorAll('.triStateCheckbox');
        for (let i = 0; i < check_boxes.length; i++) {
            let element = check_boxes[i];
            let currentState = element.getAttribute('data-state');

            if (currentState === 'Not Started') {
                element.indeterminate = false;
                element.checked = false;
            }
            else if (currentState === 'Pending') {
                element.indeterminate = true;
                element.checked = false;
            }
            else if (currentState === 'Completed') {
                element.indeterminate = false;
                element.checked = true;
            }
        }

        let url = "{% url 'project_management:project-detail' category object.pk %}";
        const save_project = (url) => {
            __save_project(url);
        }

        const toggle_target = (element, pk) => {
            url = `{% url 'project_management:project-detail' category object.pk %}?`;
            __toggle_target(element, url, pk);
        }

    </script>
{% endblock extra_js %}